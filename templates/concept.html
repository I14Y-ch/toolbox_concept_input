<!DOCTYPE html>
<html>
    <head>
        <title>{{ column.name }} - Concept Details</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    </head>
    <body>
        <div class="container">
            <header class="concept-header">
                <div class="concept-header-content">
                    <h1 class="concept-header-title">Concept Input</h1>
                    <a href="{{ url_for('results') }}" class="btn-back-overview">Back to Overview</a>
                </div>
            </header>
            
            <!-- Wizard/Stepper interface -->
            <div class="stepper">
                <div class="step-indicators">
                    <div class="step-indicator active" data-step="1">1. Generate & Edit</div>
                    <div class="step-indicator" data-step="2">2. Translate</div>
                    {% if column.is_codelist %}
                    <div class="step-indicator" data-step="3">3. Codelist</div>
                    {% endif %}
                    <div class="step-indicator" data-step="{% if column.is_codelist %}4{% else %}3{% endif %}">{% if column.is_codelist %}4{% else %}3{% endif %}. Review & Publish</div>
                </div>
                
                <div class="step-content">
                    <!-- Step 1: Generate and Edit -->
                    <div class="step-panel active" id="step-1">
                        <h3 class="panel-title">Step 1: Generate and Edit Concept Details</h3>
                        <p class="panel-description">Edit the title and description, or generate a description automatically.</p>
                        
                        <div class="form-group">
                            <label for="title">Title:</label>
                            <input type="text" id="title" class="concept-title" value="{{ column.name }}" placeholder="Enter concept title">
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description:</label>
                            <textarea id="description" class="concept-description" placeholder="Enter concept description or click Generate to create one automatically"></textarea>
                        </div>

                        <div class="action-row action-row-margin">
                            <button class="action-button generate-btn" id="generate-btn">AI Generate Description</button>
                            <div class="info-text info-text-small">
                                <i>‚ÑπÔ∏è By clicking this button, the title, current description content{% if column.is_codelist %}, and codelist values{% endif %} will be sent to OpenAI for processing.</i><br />
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="keywords">Keywords:</label>
                            <input type="text" id="keywords" class="concept-keywords" placeholder="Enter keywords separated by commas (e.g. data, statistics, analysis)">
                        </div>
                        
                        <div class="action-row">
                            <button class="action-button generate-keywords-btn" id="generate-keywords-btn" disabled>Extract Keywords</button>
                        </div>                         
                        
                        <!-- Additional fields based on the type -->
                        {% if column.type == 'Number' and not column.is_codelist %}
                        <div class="numeric-fields">
                        <div class="form-group">
                            <label for="min-value">Minimum Value:</label>
                            <input type="number" id="min-value" class="min-value" placeholder="Min value">
                        </div>
                        <div class="form-group">
                            <label for="max-value">Maximum Value:</label>
                            <input type="number" id="max-value" class="max-value" placeholder="Max value">
                        </div>
                        <div class="form-group">
                            <label for="decimals">Decimal Places:</label>
                            <input type="number" id="decimals" class="decimals" placeholder="Number of decimal places" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="unit">Measurement Unit:</label>
                            <input type="text" id="unit" class="unit" placeholder="e.g. mm, kg, ¬∞C">
                        </div>
                        <div class="form-group">
                            <label for="pattern">Pattern (regex):</label>
                            <input type="text" id="pattern" class="pattern" value="{{ column.pattern|default('') }}" placeholder="e.g. \d{1,3}">
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if column.type == 'String' and not column.is_codelist %}
                    <div class="string-fields">
                        <div class="form-group">
                            <label for="pattern">Pattern (regex):</label>
                            <input type="text" id="pattern" class="pattern" value="{{ column.pattern|default('') }}" placeholder="e.g. [A-Za-z]+">
                        </div>
                        <div class="form-group">
                            <label for="max-length">Maximum Length:</label>
                            <input type="number" id="max-length" class="max-length" placeholder="Max string length" value="255" min="1">
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if column.type == 'Date' and not column.is_codelist %}
                    <div class="date-fields">
                        <div class="form-group">
                            <label for="pattern">Pattern (regex):</label>
                            <input type="text" id="pattern" class="pattern" value="{{ column.pattern|default('') }}" placeholder="e.g. \d{4}-\d{2}-\d{2}">
                        </div>
                        <div class="form-group">
                            <label for="format">Date Format:</label>
                            <input type="text" id="format" class="format" value="{{ column.format|default('YYYY-MM-DD') }}" placeholder="e.g. YYYY-MM-DD">
                        </div>
                    </div>
                    {% endif %}
                    
                </div>
                
                <!-- Step 2: Translate -->
                <div class="step-panel" id="step-2">
                    <h3 class="panel-title">Step 2: Translate Content</h3>
                    <p class="panel-description">Translate the title and the description to all needed languages.</p>
                    
                    <div class="translations-container" id="translations-container">
                        <h4>Title Translations</h4>
                        <div class="translation-grid">
                            <div class="translation-row">
                                <div class="translation-label">DE:</div>
                                <div class="translation-field">
                                    <input type="text" id="trans-title-de" class="translation-input" value="{{ column.name }}">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">FR:</div>
                                <div class="translation-field">
                                    <input type="text" id="trans-title-fr" class="translation-input">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">IT:</div>
                                <div class="translation-field">
                                    <input type="text" id="trans-title-it" class="translation-input">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">EN:</div>
                                <div class="translation-field">
                                    <input type="text" id="trans-title-en" class="translation-input">
                                </div>
                            </div>
                        </div>
                        
                        <h4>Description Translations</h4>
                        <div class="translation-grid">
                            <div class="translation-row">
                                <div class="translation-label">DE:</div>
                                <div class="translation-field">
                                    <textarea id="trans-desc-de" class="translation-textarea"></textarea>
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">FR:</div>
                                <div class="translation-field">
                                    <textarea id="trans-desc-fr" class="translation-textarea"></textarea>
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">IT:</div>
                                <div class="translation-field">
                                    <textarea id="trans-desc-it" class="translation-textarea"></textarea>
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">EN:</div>
                                <div class="translation-field">
                                    <textarea id="trans-desc-en" class="translation-textarea"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <h4>Keyword Translations</h4>
                        <div class="translation-grid">
                            <div class="translation-row">
                                <div class="translation-label">DE:</div>
                                <div class="translation-field">
                                    <input type="text" id="trans-keywords-de" class="translation-input" placeholder="Keywords separated by commas">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">FR:</div>
                                <div class="translation-field">
                                    <input type="text" id="trans-keywords-fr" class="translation-input" placeholder="Keywords separated by commas">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">IT:</div>
                                <div class="translation-field">
                                    <input type="text" id="trans-keywords-it" class="translation-input" placeholder="Keywords separated by commas">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">EN:</div>
                                <div class="translation-field">
                                    <input type="text" id="trans-keywords-en" class="translation-input" placeholder="Keywords separated by commas">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group form-group-margin-top">
                            <button class="action-button translate-btn" id="translate-btn">Translate Content</button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Codelist (only for codelist types) -->
                {% if column.is_codelist %}
                <div class="step-panel" id="step-3">
                    <h3 class="panel-title">Step 3: Codelist Settings</h3>
                    <p class="panel-description">We detected a Codelist with the labels below. It contains {{ column.unique_count }} unique entries. 
                        On I14Y, every codelist must consist of Codes and Labels in different languages.</p>
                    
                    <div class="codelist-controls">
                        <label for="code-length">Code length:</label>
                        <select id="code-length" class="code-length">
                            <option value="2">2 characters</option>
                            <option value="3">3 characters</option>
                            <option value="4">4 characters</option>
                            <option value="5">5 characters</option>
                        </select>
                        <button class="action-button generate-codes-btn" id="generate-codes-btn">Generate Codes</button>
                    </div>
                    
                    <div class="codelist-values">
                        <h4>Codelist Values</h4>
                        <div id="generated-codes-container" class="generated-codes-hidden">
                            <table id="codes-table" class="codes-table">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>
                                            <div class="table-header-with-import">
                                                <span>Label DE</span>
                                                <button class="btn-import-column" data-lang="de" title="Import from column">üì•</button>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="table-header-with-import">
                                                <span>Label FR</span>
                                                <button class="btn-import-column" data-lang="fr" title="Import from column">üì•</button>
                                                <button class="btn-translate-column" data-lang="fr" title="Translate from DE">üåê</button>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="table-header-with-import">
                                                <span>Label IT</span>
                                                <button class="btn-import-column" data-lang="it" title="Import from column">üì•</button>
                                                <button class="btn-translate-column" data-lang="it" title="Translate from DE">üåê</button>
                                            </div>
                                        </th>
                                        <th>
                                            <div class="table-header-with-import">
                                                <span>Label EN</span>
                                                <button class="btn-import-column" data-lang="en" title="Import from column">üì•</button>
                                                <button class="btn-translate-column" data-lang="en" title="Translate from DE">üåê</button>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="codes-table-body">
                                    <!-- This will be filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div id="codelist-placeholder">
                            <p>Click "Generate Codes" to create codes for the codelist values.</p>
                            <ul>
                                {% for value in column.unique_values[:5] %}
                                <li>{{ value }}</li>
                                {% endfor %}
                                {% if column.unique_values|length > 5 %}
                                <li>... and {{ column.unique_values|length - 5 }} more values</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Column import modal (hidden by default) -->
                    <div id="column-import-modal" class="modal column-import-modal-hidden">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 id="modal-title">Import Labels</h3>
                                <button class="modal-close" id="modal-close-btn">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p id="modal-description">Select a column to import labels from:</p>
                                <div id="column-select-container">
                                    <select id="column-select" class="column-select">
                                        <option value="">-- Select a column --</option>
                                    </select>
                                </div>
                                <div id="column-preview" class="column-preview-hidden">
                                    <h4>Preview:</h4>
                                    <ul id="preview-list" class="preview-list"></ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="modal-cancel-btn">Cancel</button>
                                <button class="btn btn-primary" id="modal-import-btn" disabled>Import</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Step 4 (or 3 for non-codelists): Review and Publish -->
                <div class="step-panel" id="step-{% if column.is_codelist %}4{% else %}3{% endif %}">
                    <h3 class="panel-title">{% if column.is_codelist %}Step 4{% else %}Step 3{% endif %}: Review and Publish</h3>
                    <p class="panel-description">Review all information, make final edits if needed, and publish the concept to I14Y.</p>
                    
                    <div class="summary-section">
                        <h4>Concept Details</h4>
                        <div class="summary-label">Identifier:</div>
                        <div class="form-group">
                            <input type="text" id="concept-identifier" class="concept-identifier" placeholder="Enter concept identifier (auto-generated from column name)">
                        </div>
                        
                        <div class="summary-label">Title:</div>
                        <div class="translation-grid">
                            <div class="translation-row">
                                <div class="translation-label">DE:</div>
                                <div class="translation-field">
                                    <input type="text" id="final-title-de" class="translation-input">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">FR:</div>
                                <div class="translation-field">
                                    <input type="text" id="final-title-fr" class="translation-input">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">IT:</div>
                                <div class="translation-field">
                                    <input type="text" id="final-title-it" class="translation-input">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">EN:</div>
                                <div class="translation-field">
                                    <input type="text" id="final-title-en" class="translation-input">
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-label">Description:</div>
                        <div class="translation-grid">
                            <div class="translation-row">
                                <div class="translation-label">DE:</div>
                                <div class="translation-field">
                                    <textarea id="final-desc-de" class="translation-textarea"></textarea>
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">FR:</div>
                                <div class="translation-field">
                                    <textarea id="final-desc-fr" class="translation-textarea"></textarea>
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">IT:</div>
                                <div class="translation-field">
                                    <textarea id="final-desc-it" class="translation-textarea"></textarea>
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">EN:</div>
                                <div class="translation-field">
                                    <textarea id="final-desc-en" class="translation-textarea"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-label">Keywords:</div>
                        <div class="translation-grid">
                            <div class="translation-row">
                                <div class="translation-label">DE:</div>
                                <div class="translation-field">
                                    <input type="text" id="final-keywords-de" class="translation-input" placeholder="Keywords separated by commas">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">FR:</div>
                                <div class="translation-field">
                                    <input type="text" id="final-keywords-fr" class="translation-input" placeholder="Keywords separated by commas">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">IT:</div>
                                <div class="translation-field">
                                    <input type="text" id="final-keywords-it" class="translation-input" placeholder="Keywords separated by commas">
                                </div>
                            </div>
                            <div class="translation-row">
                                <div class="translation-label">EN:</div>
                                <div class="translation-field">
                                    <input type="text" id="final-keywords-en" class="translation-input" placeholder="Keywords separated by commas">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if column.is_codelist %}
                    <div class="summary-section codelist-section">
                        <h4>Codelist Entries</h4>
                        <div id="final-codelist-container">
                            <table id="final-codes-table" class="codes-table">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Label DE</th>
                                        <th>Label FR</th>
                                        <th>Label IT</th>
                                        <th>Label EN</th>
                                    </tr>
                                </thead>
                                <tbody id="final-codes-body">
                                    <tr><td colspan="5">No codelist entries yet. Generate codes in Step 3 first.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="action-row">
                        <button class="action-button publish-button" id="publish-button">Publish to I14Y</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status messages area -->
        <div class="status-area status-area-hidden" id="status-area">
            <div id="status-message"></div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const index = {{ index }};
            let translations = null; // Will hold translation data when available
            let token = "{{ token }}"; // Get the token from the server
            let conceptGuid = null; // Will store the GUID of the created concept
            let currentStep = 1;
            const totalSteps = {{ column.is_codelist|tojson }} ? 4 : 3;
            
            // Saved data from server
            const savedData = {{ saved_data|tojson|safe }};
            
            // Clean up token if it includes "Bearer " prefix
            if (token.startsWith('Bearer ')) {
                token = token.substring(7); // Remove "Bearer " prefix
            }
            
            // Auto-save function with debouncing
            let saveTimeout;
            function autoSaveData() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(async () => {
                    const data = collectAllFormData();
                    try {
                        await fetch(`/api/save-concept-data/${index}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });
                    } catch (error) {
                        console.error('Auto-save error:', error);
                    }
                }, 1000); // Save after 1 second of no typing
            }
            
            // Collect all form data
            function collectAllFormData() {
                const data = {
                    // Step 1 fields
                    title: document.getElementById('title')?.value || '',
                    description: document.getElementById('description')?.value || '',
                    keywords: document.getElementById('keywords')?.value || '',
                    
                    // Type-specific fields
                    min_value: document.getElementById('min-value')?.value || '',
                    max_value: document.getElementById('max-value')?.value || '',
                    decimals: document.getElementById('decimals')?.value || '',
                    unit: document.getElementById('unit')?.value || '',
                    pattern: document.getElementById('pattern')?.value || '',
                    max_length: document.getElementById('max-length')?.value || '',
                    format: document.getElementById('format')?.value || '',
                    
                    // Step 2 - Translation fields
                    trans_title_de: document.getElementById('trans-title-de')?.value || '',
                    trans_title_en: document.getElementById('trans-title-en')?.value || '',
                    trans_title_fr: document.getElementById('trans-title-fr')?.value || '',
                    trans_title_it: document.getElementById('trans-title-it')?.value || '',
                    
                    trans_desc_de: document.getElementById('trans-desc-de')?.value || '',
                    trans_desc_en: document.getElementById('trans-desc-en')?.value || '',
                    trans_desc_fr: document.getElementById('trans-desc-fr')?.value || '',
                    trans_desc_it: document.getElementById('trans-desc-it')?.value || '',
                    
                    trans_keywords_de: document.getElementById('trans-keywords-de')?.value || '',
                    trans_keywords_en: document.getElementById('trans-keywords-en')?.value || '',
                    trans_keywords_fr: document.getElementById('trans-keywords-fr')?.value || '',
                    trans_keywords_it: document.getElementById('trans-keywords-it')?.value || '',
                    
                    // Final step fields
                    concept_identifier: document.getElementById('concept-identifier')?.value || '',
                    
                    final_title_de: document.getElementById('final-title-de')?.value || '',
                    final_title_en: document.getElementById('final-title-en')?.value || '',
                    final_title_fr: document.getElementById('final-title-fr')?.value || '',
                    final_title_it: document.getElementById('final-title-it')?.value || '',
                    
                    final_desc_de: document.getElementById('final-desc-de')?.value || '',
                    final_desc_en: document.getElementById('final-desc-en')?.value || '',
                    final_desc_fr: document.getElementById('final-desc-fr')?.value || '',
                    final_desc_it: document.getElementById('final-desc-it')?.value || '',
                    
                    final_keywords_de: document.getElementById('final-keywords-de')?.value || '',
                    final_keywords_en: document.getElementById('final-keywords-en')?.value || '',
                    final_keywords_fr: document.getElementById('final-keywords-fr')?.value || '',
                    final_keywords_it: document.getElementById('final-keywords-it')?.value || '',
                    
                    // Codelist data
                    generatedCodes: window.generatedCodes || {},
                    generatedLabels: window.generatedLabels || {},
                    
                    // Current step
                    currentStep: currentStep
                };
                
                return data;
            }
            
            // Restore saved data
            function restoreSavedData() {
                if (!savedData || Object.keys(savedData).length === 0) {
                    return;
                }
                
                // Restore Step 1 fields
                if (savedData.title) document.getElementById('title').value = savedData.title;
                if (savedData.description) document.getElementById('description').value = savedData.description;
                if (savedData.keywords) document.getElementById('keywords').value = savedData.keywords;
                
                // Restore type-specific fields
                if (savedData.min_value && document.getElementById('min-value')) 
                    document.getElementById('min-value').value = savedData.min_value;
                if (savedData.max_value && document.getElementById('max-value')) 
                    document.getElementById('max-value').value = savedData.max_value;
                if (savedData.decimals && document.getElementById('decimals')) 
                    document.getElementById('decimals').value = savedData.decimals;
                if (savedData.unit && document.getElementById('unit')) 
                    document.getElementById('unit').value = savedData.unit;
                if (savedData.pattern && document.getElementById('pattern')) 
                    document.getElementById('pattern').value = savedData.pattern;
                if (savedData.max_length && document.getElementById('max-length')) 
                    document.getElementById('max-length').value = savedData.max_length;
                if (savedData.format && document.getElementById('format')) 
                    document.getElementById('format').value = savedData.format;
                
                // Restore Step 2 fields
                if (savedData.trans_title_de) document.getElementById('trans-title-de').value = savedData.trans_title_de;
                if (savedData.trans_title_en) document.getElementById('trans-title-en').value = savedData.trans_title_en;
                if (savedData.trans_title_fr) document.getElementById('trans-title-fr').value = savedData.trans_title_fr;
                if (savedData.trans_title_it) document.getElementById('trans-title-it').value = savedData.trans_title_it;
                
                if (savedData.trans_desc_de) document.getElementById('trans-desc-de').value = savedData.trans_desc_de;
                if (savedData.trans_desc_en) document.getElementById('trans-desc-en').value = savedData.trans_desc_en;
                if (savedData.trans_desc_fr) document.getElementById('trans-desc-fr').value = savedData.trans_desc_fr;
                if (savedData.trans_desc_it) document.getElementById('trans-desc-it').value = savedData.trans_desc_it;
                
                if (savedData.trans_keywords_de) document.getElementById('trans-keywords-de').value = savedData.trans_keywords_de;
                if (savedData.trans_keywords_en) document.getElementById('trans-keywords-en').value = savedData.trans_keywords_en;
                if (savedData.trans_keywords_fr) document.getElementById('trans-keywords-fr').value = savedData.trans_keywords_fr;
                if (savedData.trans_keywords_it) document.getElementById('trans-keywords-it').value = savedData.trans_keywords_it;
                
                // Restore final step fields
                if (savedData.concept_identifier) document.getElementById('concept-identifier').value = savedData.concept_identifier;
                
                if (savedData.final_title_de) document.getElementById('final-title-de').value = savedData.final_title_de;
                if (savedData.final_title_en) document.getElementById('final-title-en').value = savedData.final_title_en;
                if (savedData.final_title_fr) document.getElementById('final-title-fr').value = savedData.final_title_fr;
                if (savedData.final_title_it) document.getElementById('final-title-it').value = savedData.final_title_it;
                
                if (savedData.final_desc_de) document.getElementById('final-desc-de').value = savedData.final_desc_de;
                if (savedData.final_desc_en) document.getElementById('final-desc-en').value = savedData.final_desc_en;
                if (savedData.final_desc_fr) document.getElementById('final-desc-fr').value = savedData.final_desc_fr;
                if (savedData.final_desc_it) document.getElementById('final-desc-it').value = savedData.final_desc_it;
                
                if (savedData.final_keywords_de) document.getElementById('final-keywords-de').value = savedData.final_keywords_de;
                if (savedData.final_keywords_en) document.getElementById('final-keywords-en').value = savedData.final_keywords_en;
                if (savedData.final_keywords_fr) document.getElementById('final-keywords-fr').value = savedData.final_keywords_fr;
                if (savedData.final_keywords_it) document.getElementById('final-keywords-it').value = savedData.final_keywords_it;
                
                // Restore codelist data
                if (savedData.generatedCodes) {
                    window.generatedCodes = savedData.generatedCodes;
                }
                if (savedData.generatedLabels) {
                    window.generatedLabels = savedData.generatedLabels;
                    // Rebuild the codelist table if data exists
                    if (Object.keys(savedData.generatedLabels).length > 0) {
                        rebuildCodelistTable();
                    }
                }
                
                // Restore current step
                if (savedData.currentStep) {
                    currentStep = savedData.currentStep;
                    updateStepperState();
                }
            }
            
            // Rebuild codelist table from saved data
            function rebuildCodelistTable() {
                if (!window.generatedCodes || !window.generatedLabels) {
                    return;
                }
                
                const tbody = document.getElementById('codes-table-body');
                if (!tbody) return;
                
                const container = document.getElementById('generated-codes-container');
                const placeholder = document.getElementById('codelist-placeholder');
                
                if (container && placeholder) {
                    container.style.display = 'block';
                    placeholder.style.display = 'none';
                }
                
                tbody.innerHTML = '';
                
                const values = Object.keys(window.generatedCodes);
                values.forEach(value => {
                    const code = window.generatedCodes[value];
                    const labels = window.generatedLabels[value] || {de: '', fr: '', it: '', en: ''};
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="text" class="code-edit" data-value="${value}" value="${code}"></td>
                        <td><input type="text" class="label-edit label-de" data-value="${value}" value="${labels.de || ''}"></td>
                        <td><input type="text" class="label-edit label-fr" data-value="${value}" value="${labels.fr || ''}"></td>
                        <td><input type="text" class="label-edit label-it" data-value="${value}" value="${labels.it || ''}"></td>
                        <td><input type="text" class="label-edit label-en" data-value="${value}" value="${labels.en || ''}"></td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Attach change listeners to codelist inputs
                attachCodelistListeners();
            }
            
            // Attach change listeners to all form inputs
            function attachAutoSaveListeners() {
                const inputs = document.querySelectorAll('input[type="text"], textarea, input[type="number"], select');
                inputs.forEach(input => {
                    input.addEventListener('input', autoSaveData);
                    input.addEventListener('change', autoSaveData);
                });
            }
            
            // Attach listeners to codelist inputs
            function attachCodelistListeners() {
                document.querySelectorAll('.code-edit, .label-edit').forEach(input => {
                    input.addEventListener('change', function() {
                        const value = this.getAttribute('data-value');
                        if (this.classList.contains('code-edit')) {
                            window.generatedCodes[value] = this.value;
                        } else {
                            const lang = this.classList.contains('label-de') ? 'de' :
                                        this.classList.contains('label-fr') ? 'fr' :
                                        this.classList.contains('label-it') ? 'it' : 'en';
                            if (!window.generatedLabels[value]) {
                                window.generatedLabels[value] = {de: '', fr: '', it: '', en: ''};
                            }
                            window.generatedLabels[value][lang] = this.value;
                        }
                        autoSaveData();
                    });
                });
            }
            
            // Initialize on page load
            restoreSavedData();
            attachAutoSaveListeners();
            
            // Save data before navigating away
            window.addEventListener('beforeunload', function() {
                // Force immediate save (no debounce)
                clearTimeout(saveTimeout);
                const data = collectAllFormData();
                navigator.sendBeacon(`/api/save-concept-data/${index}`, JSON.stringify(data));
            });
            
            // Also save when clicking navigation links
            document.querySelectorAll('.btn-back-overview, .pagination-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    // Save immediately before navigation
                    clearTimeout(saveTimeout);
                    const data = collectAllFormData();
                    fetch(`/api/save-concept-data/${index}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data),
                        keepalive: true
                    });
                });
            });
            
            // Initialize stepper
            function updateStepperState() {
                // Update step indicators
                document.querySelectorAll('.step-indicator').forEach(el => {
                    const step = parseInt(el.dataset.step);
                    el.classList.remove('active', 'completed');
                    
                    if (step === currentStep) {
                        el.classList.add('active');
                    } else if (step < currentStep) {
                        el.classList.add('completed');
                    }
                });
                
                // Update panels visibility - FIXED to handle codelist/non-codelist case
                document.querySelectorAll('.step-panel').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Find the correct panel ID based on current step
                let panelId;
                if ({{ column.is_codelist|tojson }}) {
                    // For codelists, panels are step-1, step-2, step-3, step-4
                    panelId = `step-${currentStep}`;
                } else {
                    // For non-codelists, we need to map step numbers differently
                    // Because there's no step-3 panel for non-codelists
                    if (currentStep === 3) {
                        // Skip to the final panel (which has ID step-3 for non-codelists)
                        panelId = 'step-3';
                    } else {
                        panelId = `step-${currentStep}`; 
                    }
                }
                
                const panelElement = document.getElementById(panelId);
                if (panelElement) {
                    panelElement.classList.add('active');
                } else {
                    console.error(`Panel with ID ${panelId} not found`);
                }
            }
            
            // Step indicator clicks
            document.querySelectorAll('.step-indicator').forEach(indicator => {
                indicator.addEventListener('click', function() {
                    const targetStep = parseInt(this.dataset.step);
                    // Only allow navigating to completed steps or the next step
                    if (targetStep <= currentStep || targetStep === currentStep + 1) {
                        // Update the translation step if moving to Step 2
                        if (targetStep === 2) {
                            updateDescriptionStep();
                        }
                        
                        // Update the summary panel if moving to the final step
                        if (targetStep === totalSteps) {
                            updateSummaryPanel();
                        }
                        
                        currentStep = targetStep;
                        updateStepperState();
                        autoSaveData(); // Auto-save when changing steps
                    }
                });
            });
            
            // Update the summary panel with the current title and description
            async function updateDescriptionStep() {
                const title = document.getElementById('title').value.trim();
                const description = document.getElementById('description').value.trim();
                
                // First detect the language of the title/description
                let detectedLang = 'DE'; // Default to German
                try {
                    // Use the longer text for better language detection
                    const textToDetect = description.length > title.length ? description : title;
                    if (textToDetect) {
                        detectedLang = await detectLanguage(textToDetect);
                        
                        // Update the detected language display
                        const detectedLangEl = document.getElementById('detected-language');
                        if (detectedLangEl) {
                            detectedLangEl.textContent = detectedLang;
                        }
                    }
                } catch (error) {
                    console.error('Error detecting language:', error);
                }
                
                // Clear all language fields first
                document.getElementById('trans-title-de').value = '';
                document.getElementById('trans-title-en').value = '';
                document.getElementById('trans-title-fr').value = '';
                document.getElementById('trans-title-it').value = '';
                
                document.getElementById('trans-desc-de').value = '';
                document.getElementById('trans-desc-en').value = '';
                document.getElementById('trans-desc-fr').value = '';
                document.getElementById('trans-desc-it').value = '';
                
                document.getElementById('trans-keywords-de').value = '';
                document.getElementById('trans-keywords-en').value = '';
                document.getElementById('trans-keywords-fr').value = '';
                document.getElementById('trans-keywords-it').value = '';
                
                // Only fill the field for the detected language
                const langCode = detectedLang.toLowerCase();
                if (['de', 'en', 'fr', 'it'].includes(langCode)) {
                    document.getElementById(`trans-title-${langCode}`).value = title;
                    document.getElementById(`trans-desc-${langCode}`).value = description;
                    
                    // Also sync keywords from Step 1 to the detected language field in Step 2
                    const keywords = document.getElementById('keywords').value.trim();
                    if (keywords) {
                        document.getElementById(`trans-keywords-${langCode}`).value = keywords;
                    }
                } else {
                    // If it's an unsupported language, default to German
                    document.getElementById('trans-title-de').value = title;
                    document.getElementById('trans-desc-de').value = description;
                }
            }
            
            // Function to update summary panel - updated to fill editable fields
            function updateSummaryPanel() {
                // Get all the translated values from the inputs
                const translatedTitle = {
                    de: document.getElementById('trans-title-de').value,
                    en: document.getElementById('trans-title-en').value,
                    fr: document.getElementById('trans-title-fr').value,
                    it: document.getElementById('trans-title-it').value,
                    rm: document.getElementById('trans-title-de').value // Default to DE for Romansh
                };
                
                const translatedDesc = {
                    de: document.getElementById('trans-desc-de').value,
                    en: document.getElementById('trans-desc-en').value,
                    fr: document.getElementById('trans-desc-fr').value,
                    it: document.getElementById('trans-desc-it').value,
                    rm: document.getElementById('trans-desc-de').value // Default to DE for Romansh
                };
                
                const translatedKeywords = {
                    de: document.getElementById('trans-keywords-de').value,
                    en: document.getElementById('trans-keywords-en').value,
                    fr: document.getElementById('trans-keywords-fr').value,
                    it: document.getElementById('trans-keywords-it').value,
                    rm: document.getElementById('trans-keywords-de').value // Default to DE for Romansh
                };
                
                // Update the translations object with values from previous step
                translations = {
                    title: translatedTitle,
                    description: translatedDesc,
                    keywords: translatedKeywords
                };
                
                // Update the editable summary fields
                document.getElementById('final-title-de').value = translatedTitle.de;
                document.getElementById('final-title-en').value = translatedTitle.en;
                document.getElementById('final-title-fr').value = translatedTitle.fr;
                document.getElementById('final-title-it').value = translatedTitle.it;
                
                document.getElementById('final-desc-de').value = translatedDesc.de;
                document.getElementById('final-desc-en').value = translatedDesc.en;
                document.getElementById('final-desc-fr').value = translatedDesc.fr;
                document.getElementById('final-desc-it').value = translatedDesc.it;
                
                document.getElementById('final-keywords-de').value = translatedKeywords.de;
                document.getElementById('final-keywords-en').value = translatedKeywords.en;
                document.getElementById('final-keywords-fr').value = translatedKeywords.fr;
                document.getElementById('final-keywords-it').value = translatedKeywords.it;
                
                // Pre-fill identifier with auto-generated value
                const autoGeneratedIdentifier = "{{ column.name }}".replace(/ /g, '_').toUpperCase();
                document.getElementById('concept-identifier').value = autoGeneratedIdentifier;
                
                // Update codelist summary if applicable
                if ({{ column.is_codelist|tojson }}) {
                    if (window.generatedCodes && window.generatedLabels) {
                        updateFinalCodelistTable();
                    }
                }
            }
            
            // Function to update the final codelist table
            function updateFinalCodelistTable() {
                if (!window.generatedCodes || !window.generatedLabels) {
                    return;
                }
                
                const tbody = document.getElementById('final-codes-body');
                tbody.innerHTML = '';
                
                const values = Object.keys(window.generatedCodes);
                if (values.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No codelist entries yet. Generate codes in Step 3 first.</td></tr>';
                    return;
                }
                
                values.forEach(value => {
                    const code = window.generatedCodes[value];
                    const labels = window.generatedLabels[value];
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <input type="text" class="final-code-edit" 
                                   data-value="${value}" 
                                   value="${code}">
                        </td>
                        <td>
                            <input type="text" class="final-label-edit" 
                                   data-value="${value}" data-lang="de" 
                                   value="${labels.de}">
                        </td>
                        <td>
                            <input type="text" class="final-label-edit" 
                                   data-value="${value}" data-lang="fr" 
                                   value="${labels.fr}">
                        </td>
                        <td>
                            <input type="text" class="final-label-edit" 
                                   data-value="${value}" data-lang="it" 
                                   value="${labels.it}">
                        </td>
                        <td>
                            <input type="text" class="final-label-edit" 
                                   data-value="${value}" data-lang="en" 
                                   value="${labels.en}">
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Function to detect language
            async function detectLanguage(text) {
                try {
                    const response = await fetch('/api/translate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: text,
                            source_lang: 'auto'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Language detection failed');
                    }
                    
                    const result = await response.json();
                    if (result.translations && result.translations.source_lang) {
                        return result.translations.source_lang;
                    }
                    return 'DE'; // Default to German if detection fails
                } catch (error) {
                    console.error('Language detection error:', error);
                    return 'DE'; // Default to German if detection fails
                }
            }
            
            // Simple function to collect form values
            function getFormValues() {
                const values = {
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value
                };
                
                // Add numeric fields if they exist
                const minValueEl = document.getElementById('min-value');
                const maxValueEl = document.getElementById('max-value');
                const decimalsEl = document.getElementById('decimals');
                const unitEl = document.getElementById('unit');
                
                if (minValueEl) values.min_value = minValueEl.value;
                if (maxValueEl) values.max_value = maxValueEl.value;
                if (decimalsEl) values.decimals = decimalsEl.value;
                if (unitEl) values.unit = unitEl.value;
                
                // Add string fields if they exist
                const patternEl = document.getElementById('pattern');
                const maxLengthEl = document.getElementById('max-length');
                
                if (patternEl) values.pattern = patternEl.value;
                if (maxLengthEl) values.max_length = maxLengthEl.value;
                
                // Add date fields if they exist
                const formatEl = document.getElementById('format');
                if (formatEl) values.format = formatEl.value;
                
                return values;
            }
            
            // Enable/disable Extract Keywords button based on description length
            const descriptionTextarea = document.getElementById('description');
            const generateKeywordsBtn = document.getElementById('generate-keywords-btn');
            
            function updateKeywordsButtonState() {
                const description = descriptionTextarea.value.trim();
                if (description.length >= 100) {
                    generateKeywordsBtn.disabled = false;
                } else {
                    generateKeywordsBtn.disabled = true;
                }
            }
            
            // Check on input/change events
            descriptionTextarea.addEventListener('input', updateKeywordsButtonState);
            descriptionTextarea.addEventListener('change', updateKeywordsButtonState);
            
            // Initial check on page load
            updateKeywordsButtonState();
            
            // Generate button handler - updated to send comprehensive data to OpenAI
            document.getElementById('generate-btn').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;
                
                try {
                    // Show loading state
                    button.disabled = true;
                    button.textContent = 'üîÑ Generating...';
                    showStatus('info', 'Generating description with AI...');
                    
                    // Get current form values
                    const title = document.getElementById('title').value.trim();
                    const currentDescription = document.getElementById('description').value.trim();
                    
                    if (!title) {
                        showStatus('error', 'Please enter a title before generating a description');
                        button.disabled = false;
                        button.textContent = originalText;
                        return;
                    }
                    
                    // Detect the language of the title
                    const detectedLang = await detectLanguage(title);
                    
                    // Prepare data to send to OpenAI
                    const requestData = {
                        title: title,
                        description: currentDescription,
                        lang: detectedLang.toLowerCase()
                    };
                    
                    // Add codelist values if this is a codelist column
                    {% if column.is_codelist and column.unique_values %}
                    if ({{ column.is_codelist|tojson }}) {
                        const codelistValues = {{ column.unique_values|tojson }};
                        if (codelistValues && codelistValues.length > 0) {
                            requestData.codelist_values = codelistValues;
                        }
                    }
                    {% endif %}
                    
                    // Call the backend with comprehensive data
                    const response = await fetch(`/api/generate-description/${index}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Set the description in the textarea only
                        document.getElementById('description').value = data.description;
                        
                        // Update the keywords button state after setting description
                        updateKeywordsButtonState();
                        
                        // Set other form fields if they exist
                        if (data.params) {
                            const params = data.params;
                            
                            if (params.min_value !== undefined) {
                                const el = document.getElementById('min-value');
                                if (el) el.value = params.min_value;
                            }
                            
                            if (params.max_value !== undefined) {
                                const el = document.getElementById('max-value');
                                if (el) el.value = params.max_value;
                            }
                            
                            if (params.decimals !== undefined) {
                                const el = document.getElementById('decimals');
                                if (el) el.value = params.decimals;
                            }
                            
                            if (params.unit !== undefined) {
                                const el = document.getElementById('unit');
                                if (el) el.value = params.unit;
                            }
                            
                            if (params.pattern !== undefined) {
                                const el = document.getElementById('pattern');
                                if (el) el.value = params.pattern;
                            }
                            
                            if (params.max_length !== undefined) {
                                const el = document.getElementById('max-length');
                                if (el) el.value = params.max_length;
                            }
                            
                            // Set format field if it exists
                            if (params.format !== undefined) {
                                const el = document.getElementById('format');
                                if (el) el.value = params.format;
                            }
                        }
                        
                        showStatus('success', `AI-generated description created in ${detectedLang}`);
                        button.textContent = originalText;
                        button.disabled = false;
                    } else {
                        showStatus('error', data.error || 'Failed to generate description');
                        button.textContent = originalText;
                        button.disabled = false;
                    }
                } catch (error) {
                    console.error('Generate description error:', error);
                    showStatus('error', `Error: ${error.message}`);
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
            
            // Generate Keywords button handler
            document.getElementById('generate-keywords-btn').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;
                
                try {
                    // Show loading state
                    button.disabled = true;
                    button.textContent = 'üîÑ Extracting...';
                    
                    const title = document.getElementById('title').value.trim();
                    const description = document.getElementById('description').value.trim();
                    
                    if (!title && !description) {
                        showStatus('error', 'Please enter a title or description before extracting keywords');
                        button.disabled = false;
                        button.textContent = originalText;
                        return;
                    }
                    
                    if (description.length < 100) {
                        showStatus('error', 'Description must be at least 100 characters long for keyword extraction');
                        button.disabled = false;
                        button.textContent = originalText;
                        return;
                    }
                    
                    // Detect the language of the content
                    const textToDetect = description.length > title.length ? description : title;
                    const detectedLang = await detectLanguage(textToDetect);
                    
                    // Prepare data to send to backend
                    const requestData = {
                        title: title,
                        description: description,
                        lang: detectedLang.toLowerCase()
                    };
                    
                    showStatus('info', 'Extracting keywords...');
                    
                    // Call the backend keyword extraction API
                    const response = await fetch(`/api/extract-keywords/${index}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Set the keywords in the input field
                        document.getElementById('keywords').value = data.keywords;
                        
                        showStatus('success', `Keywords extracted successfully in ${detectedLang}`);
                        button.textContent = originalText;
                        button.disabled = false;
                    } else {
                        showStatus('error', data.error || 'Failed to extract keywords');
                        button.textContent = originalText;
                        button.disabled = false;
                    }
                } catch (error) {
                    console.error('Keyword extraction error:', error);
                    showStatus('error', `Error: ${error.message}`);
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
            
            // Translate button handler - Add fallback for cases where detected-language element isn't found
            document.getElementById('translate-btn').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;
                
                const title = document.getElementById('trans-title-de').value;
                const description = document.getElementById('trans-desc-de').value;
                const keywords = document.getElementById('trans-keywords-de').value;
                
                if (!title && !description && !keywords) {
                    showStatus('error', 'Please provide a title, description, or keywords before translating');
                    return;
                }
                
                try {
                    // Show loading state
                    button.disabled = true;
                    button.textContent = 'üîÑ Translating...';
                    showStatus('info', 'Translating content...');
                    
                    // Detect language from the longer text (description or title)
                    const textToDetect = description.length > title.length ? description : title;
                    const detectedLang = await detectLanguage(textToDetect);
                    
                    // Add null check to prevent errors if element doesn't exist
                    const detectedLangEl = document.getElementById('detected-language');
                    if (detectedLangEl) {
                        detectedLangEl.textContent = detectedLang;
                    }
                    
                    // Call translation API with the detected language
                    const response = await fetch('/api/translate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: title,
                            description: description,
                            keywords: keywords,
                            source_lang: detectedLang
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Translation failed');
                    }
                    
                    // Store translations for later use
                    translations = await response.json();
                    
                    // Update all translation inputs, preserving the source language
                    const langs = ['de', 'en', 'fr', 'it'];
                    
                    langs.forEach(lang => {
                        // Skip the detected language to preserve user's original input
                        if (lang.toUpperCase() !== detectedLang) {
                            document.getElementById(`trans-title-${lang}`).value = translations.title[lang];
                            document.getElementById(`trans-desc-${lang}`).value = translations.description[lang];
                            document.getElementById(`trans-keywords-${lang}`).value = translations.keywords ? translations.keywords[lang] : '';
                        }
                    });
                    
                    showStatus('success', 'Translation completed successfully.');
                    button.textContent = originalText;
                    button.disabled = false;
                } catch (error) {
                    console.error('Translation error:', error);
                    showStatus('error', `Error: ${error.message}`);
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
            
            // Generate Codes button handler (for codelists)
            {% if column.is_codelist %}
            document.getElementById('generate-codes-btn').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;
                
                try {
                    // Show loading state
                    button.disabled = true;
                    button.textContent = 'üîÑ Generating...';
                    
                    const codeLength = document.getElementById('code-length').value;
                    showStatus('info', 'Generating codes...');
                    
                    // Hide placeholder
                    document.getElementById('codelist-placeholder').style.display = 'none';
                    // Show codes container
                    document.getElementById('generated-codes-container').style.display = 'block';
                    document.getElementById('codes-table-body').innerHTML = '<tr><td colspan="5">Generating codes...</td></tr>';
                    
                    // Call the API to generate codes
                    const response = await fetch(`/api/generate-codes/${index}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            codeLength: parseInt(codeLength)
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to generate codes');
                    }
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message || 'Unknown error');
                    }
                    
                    // First, detect the language of each value - we'll do this in batches
                    const detectedLanguages = {};
                    const batchSize = 10;
                    const uniqueValues = result.codes.map(item => item.value);
                    
                    for (let i = 0; i < uniqueValues.length; i += batchSize) {
                        const batch = uniqueValues.slice(i, i + batchSize);
                        await Promise.all(batch.map(async (value) => {
                            try {
                                const textToDetect = value.toString();
                                if (!textToDetect.trim()) return; // Skip empty values
                                
                                const lang = await detectLanguage(textToDetect);
                                detectedLanguages[value] = lang.toLowerCase();
                            } catch (err) {
                                console.error(`Language detection error for "${value}":`, err);
                                detectedLanguages[value] = 'de'; // Default to German if detection fails
                            }
                        }));
                    }
                    
                    // Display the generated codes with multilingual label fields
                    const tbody = document.getElementById('codes-table-body');
                    tbody.innerHTML = '';
                    
                    // Create a map to store codes and labels
                    window.generatedCodes = {};
                    window.generatedLabels = {};
                    
                    result.codes.forEach(item => {
                        // Determine which language column to prefill
                        const detectedLang = detectedLanguages[item.value] || 'de';
                        
                        // Store code and initialize empty labels
                        window.generatedCodes[item.value] = item.code;
                        window.generatedLabels[item.value] = {
                            de: '',
                            fr: '',
                            it: '',
                            en: ''
                        };
                        
                        // Only fill the detected language column
                        window.generatedLabels[item.value][detectedLang] = item.value;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <input type="text" class="code-edit" 
                                       data-value="${item.value}" 
                                       value="${item.code}" 
                                       maxlength="${codeLength}">
                            </td>
                            <td>
                                <input type="text" class="label-edit label-de" 
                                       data-value="${item.value}" 
                                       value="${detectedLang === 'de' ? item.value : ''}">
                            </td>
                            <td>
                                <input type="text" class="label-edit label-fr" 
                                       data-value="${item.value}" 
                                       value="${detectedLang === 'fr' ? item.value : ''}">
                            </td>
                            <td>
                                <input type="text" class="label-edit label-it" 
                                       data-value="${item.value}" 
                                       value="${detectedLang === 'it' ? item.value : ''}">
                            </td>
                            <td>
                                <input type="text" class="label-edit label-en" 
                                       data-value="${item.value}" 
                                       value="${detectedLang === 'en' ? item.value : ''}">
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Set up inputs to automatically update the stored values when changed
                    document.querySelectorAll('.code-edit').forEach(input => {
                        input.addEventListener('change', function() {
                            const value = this.getAttribute('data-value');
                            window.generatedCodes[value] = this.value;
                            autoSaveData(); // Auto-save when codes change
                        });
                    });
                    
                    document.querySelectorAll('.label-edit').forEach(input => {
                        input.addEventListener('change', function() {
                            const value = this.getAttribute('data-value');
                            const lang = this.classList.contains('label-de') ? 'de' : 
                                         this.classList.contains('label-fr') ? 'fr' :
                                         this.classList.contains('label-it') ? 'it' : 'en';
                            
                            if (!window.generatedLabels[value]) {
                                window.generatedLabels[value] = {de: '', fr: '', it: '', en: ''};
                            }
                            window.generatedLabels[value][lang] = this.value;
                            autoSaveData(); // Auto-save when labels change
                        });
                    });
                    
                    showStatus('success', `Generated ${result.codes.length} codes for codelist values. Labels have been placed in their detected language columns. Use the translate buttons (üåê) in column headers to translate to other languages.`);
                    button.textContent = originalText;
                    button.disabled = false;
                    autoSaveData(); // Auto-save after generating codes
                    
                } catch (error) {
                    console.error('Generate codes error:', error);
                    showStatus('error', `Error: ${error.message}`);
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
            
            // Column-specific translate button handler
            document.addEventListener('click', async function(e) {
                if (e.target.classList.contains('btn-translate-column')) {
                    const button = e.target;
                    const targetLang = button.dataset.lang;
                    const originalText = button.textContent;
                    
                    try {
                        // Show loading state
                        button.disabled = true;
                        button.textContent = 'üîÑ';
                        showStatus('info', `Translating to ${targetLang.toUpperCase()}...`);
                        
                        // Get all the DE labels
                        const labelInputs = document.querySelectorAll('.label-edit.label-de');
                        const translations = {};
                        
                        // Process translations in batches to avoid overloading the API
                        const batchSize = 10;
                        for (let i = 0; i < labelInputs.length; i += batchSize) {
                            const batch = Array.from(labelInputs).slice(i, i + batchSize);
                            
                            await Promise.all(batch.map(async input => {
                                const value = input.getAttribute('data-value');
                                const text = input.value;
                                
                                if (!text.trim()) return; // Skip empty values
                                
                                try {
                                    const response = await fetch('/api/translate', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            text: text,
                                            source_lang: 'DE'
                                        })
                                    });
                                    
                                    if (!response.ok) {
                                        throw new Error(`Failed to translate "${text}"`);
                                    }
                                    
                                    const result = await response.json();
                                    translations[value] = result.translations || {};
                                } catch (err) {
                                    console.error(`Translation error for "${text}":`, err);
                                    translations[value] = {};
                                }
                            }));
                            
                            // Update status for batches
                            showStatus('info', `Translating to ${targetLang.toUpperCase()}... (${Math.min(i + batchSize, labelInputs.length)}/${labelInputs.length})`);
                        }
                        
                        // Update only the target language column
                        for (const value in translations) {
                            const trans = translations[value];
                            
                            // Update window.generatedLabels as well
                            if (!window.generatedLabels[value]) {
                                window.generatedLabels[value] = {de: '', fr: '', it: '', en: ''};
                            }
                            
                            const germanLabel = document.querySelector(`.label-de[data-value="${value}"]`).value;
                            
                            // Only update the specific target language
                            if (trans[targetLang] && trans[targetLang].trim()) {
                                window.generatedLabels[value][targetLang] = trans[targetLang];
                                const targetInput = document.querySelector(`.label-${targetLang}[data-value="${value}"]`);
                                if (targetInput) {
                                    targetInput.value = trans[targetLang];
                                }
                            } else {
                                console.log(`Empty ${targetLang.toUpperCase()} translation for "${germanLabel}", keeping original`);
                            }
                        }
                        
                        button.textContent = originalText;
                        button.disabled = false;
                    } catch (error) {
                        console.error('Translate column error:', error);
                        showStatus('error', `Error: ${error.message}`);
                        button.textContent = originalText;
                        button.disabled = false;
                    }
                }
            });
            
            // Import column functionality for codelist labels
            let availableColumns = null;
            let currentImportLang = null;
            
            // Load available columns when first import button is clicked
            async function loadAvailableColumns() {
                if (availableColumns !== null) {
                    return availableColumns;
                }
                
                try {
                    const response = await fetch(`/api/codelist/label-columns/${index}`, {
                        method: 'GET'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load columns');
                    }
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Unknown error');
                    }
                    
                    availableColumns = result.candidates;
                    return availableColumns;
                    
                } catch (error) {
                    console.error('Load columns error:', error);
                    showStatus('error', `Error: ${error.message}`);
                    return [];
                }
            }
            
            // Handle import button clicks
            document.addEventListener('click', async function(e) {
                if (e.target.classList.contains('btn-import-column')) {
                    const lang = e.target.dataset.lang;
                    currentImportLang = lang;
                    
                    // Load available columns
                    showStatus('info', 'Loading available columns...');
                    const columns = await loadAvailableColumns();
                    
                    if (columns.length === 0) {
                        showStatus('error', 'No additional columns available for import');
                        return;
                    }
                    
                    // Populate the select dropdown
                    const select = document.getElementById('column-select');
                    select.innerHTML = '<option value="">-- Select a column --</option>';
                    
                    // Filter and sort columns - prefer matching language
                    const sortedColumns = [...columns].sort((a, b) => {
                        // Prioritize columns matching the target language
                        if (a.language === lang && b.language !== lang) return -1;
                        if (a.language !== lang && b.language === lang) return 1;
                        return a.name.localeCompare(b.name);
                    });
                    
                    sortedColumns.forEach(col => {
                        const option = document.createElement('option');
                        option.value = col.name;
                        option.textContent = col.name;
                        option.dataset.samples = JSON.stringify(col.samples);
                        
                        // Add indicator if language matches
                        if (col.language === lang) {
                            option.textContent += ` ‚úì`;
                        }
                        
                        select.appendChild(option);
                    });
                    
                    // Update modal title
                    const langNames = {
                        'de': 'German',
                        'fr': 'French',
                        'it': 'Italian',
                        'en': 'English'
                    };
                    document.getElementById('modal-title').textContent = `Import ${langNames[lang]} Labels`;
                    document.getElementById('modal-description').textContent = `Select a column to import ${langNames[lang]} labels from:`;
                    
                    // Show modal
                    document.getElementById('column-import-modal').style.display = 'flex';
                    showStatus('success', `Found ${columns.length} columns`);
                }
            });
            
            // Column select change handler
            document.getElementById('column-select').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const importBtn = document.getElementById('modal-import-btn');
                
                if (this.value) {
                    // Show preview
                    const samples = JSON.parse(selectedOption.dataset.samples || '[]');
                    const previewList = document.getElementById('preview-list');
                    previewList.innerHTML = '';
                    
                    samples.forEach(sample => {
                        const li = document.createElement('li');
                        li.textContent = sample;
                        previewList.appendChild(li);
                    });
                    
                    document.getElementById('column-preview').style.display = 'block';
                    importBtn.disabled = false;
                } else {
                    document.getElementById('column-preview').style.display = 'none';
                    importBtn.disabled = true;
                }
            });
            
            // Modal close handlers
            document.getElementById('modal-close-btn').addEventListener('click', function() {
                document.getElementById('column-import-modal').style.display = 'none';
            });
            
            document.getElementById('modal-cancel-btn').addEventListener('click', function() {
                document.getElementById('column-import-modal').style.display = 'none';
            });
            
            // Modal import handler
            document.getElementById('modal-import-btn').addEventListener('click', async function() {
                const selectedColumn = document.getElementById('column-select').value;
                
                if (!selectedColumn || !currentImportLang) {
                    return;
                }
                
                const button = this;
                const originalText = button.textContent;
                
                try {
                    button.disabled = true;
                    button.textContent = 'üîÑ Importing...';
                    showStatus('info', `Importing ${currentImportLang.toUpperCase()} labels from ${selectedColumn}...`);
                    
                    // Get the code column name
                    const codeColumn = "{{ column.name }}";
                    
                    // Call the API to add labels for this specific language
                    const response = await fetch('/api/codelist/add-labels', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            codeColumn: codeColumn,
                            labelColumns: [{
                                name: selectedColumn,
                                lang: currentImportLang
                            }]
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to import labels');
                    }
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Unknown error');
                    }
                    
                    // Update the table with imported labels for this language
                    result.labels.forEach(item => {
                        const code = item.code;
                        const label = item.labels[currentImportLang];
                        
                        if (label) {
                            // Find the input for this code and language
                            const input = document.querySelector(`.label-${currentImportLang}[data-value="${code}"]`);
                            if (input) {
                                input.value = label;
                                
                                // Update stored labels
                                if (!window.generatedLabels[code]) {
                                    window.generatedLabels[code] = {de: '', fr: '', it: '', en: ''};
                                }
                                window.generatedLabels[code][currentImportLang] = label;
                            }
                        }
                    });
                    
                    // Close modal
                    document.getElementById('column-import-modal').style.display = 'none';
                    
                    showStatus('success', `Imported ${result.labels.length} ${currentImportLang.toUpperCase()} labels from "${selectedColumn}"`);
                    button.textContent = originalText;
                    button.disabled = false;
                    
                } catch (error) {
                    console.error('Import labels error:', error);
                    showStatus('error', `Error: ${error.message}`);
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
            
            {% endif %}
            
            // Track if we've already submitted this concept to prevent duplicates
            let conceptSubmitted = false;
            
            // Combined publish button handler (replaces separate create-concept and add-codelist)
            document.getElementById('publish-button').addEventListener('click', async function() {
                const button = this;
                
                // Prevent multiple submissions
                if (conceptSubmitted) {
                    showStatus('info', 'This concept has already been submitted');
                    return;
                }
                
                // Disable button to prevent double-clicks
                button.disabled = true;
                button.textContent = 'Publishing...';
                
                // Get final values from editable fields
                const finalTitle = {
                    de: document.getElementById('final-title-de').value,
                    en: document.getElementById('final-title-en').value,
                    fr: document.getElementById('final-title-fr').value,
                    it: document.getElementById('final-title-it').value,
                    rm: document.getElementById('final-title-de').value // Default to DE for Romansh
                };
                
                const finalDesc = {
                    de: document.getElementById('final-desc-de').value,
                    en: document.getElementById('final-desc-en').value,
                    fr: document.getElementById('final-desc-fr').value,
                    it: document.getElementById('final-desc-it').value,
                    rm: document.getElementById('final-desc-de').value // Default to DE for Romansh
                };
                
                const finalKeywords = {
                    de: document.getElementById('final-keywords-de').value,
                    en: document.getElementById('final-keywords-en').value,
                    fr: document.getElementById('final-keywords-fr').value,
                    it: document.getElementById('final-keywords-it').value,
                    rm: document.getElementById('final-keywords-de').value // Default to DE for Romansh
                };
                
                // Collect all other form values
                const values = getFormValues();
                
                // Use the final title and description
                values.title = finalTitle.de; // Main title is DE
                values.description = finalDesc.de; // Main description is DE
                
                // Use the final translations
                values.translations = {
                    title: finalTitle,
                    description: finalDesc,
                    keywords: finalKeywords
                };
                
                // Add keywords
                values.keywords = document.getElementById('keywords').value;
                
                // Add custom identifier
                values.identifier = document.getElementById('concept-identifier').value.trim();
                
                // Add index to the values
                values.index = index;
                
                try {
                    showStatus('info', 'Creating and submitting concept to I14Y...');
                    
                    // Step 1: Create the concept
                    const response = await fetch('/api/submit-concept', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(values)
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok || !result.success) {
                        let errorMsg = 'API submission failed';
                        if (result.message) {
                            errorMsg += `: ${result.message}`;
                        } else if (result.error) {
                            errorMsg += `: ${result.error}`;
                        }
                        throw new Error(errorMsg);
                    }
                    
                    // Concept creation succeeded
                    conceptSubmitted = true;
                    
                    // Get the concept GUID
                    if (result.location) {
                        const locationParts = result.location.split('/');
                        conceptGuid = locationParts[locationParts.length - 1];
                    } else if (result.conflict && result.existing_concept && result.existing_concept.data) {
                        conceptGuid = result.existing_concept.data.guid;
                    }
                    
                    // Create I14Y URL for concept
                    let i14yUrl = null;
                    if (conceptGuid) {
                        i14yUrl = `https://input.i14y.admin.ch/catalog/concepts/${conceptGuid}/description`;
                    } else if (result.i14y_url) {
                        i14yUrl = result.i14y_url;
                    }
                    
                    // Show concept creation status
                    showStatus('success', result.message || 'Concept created or already exists in I14Y', i14yUrl);
                    
                    // Step 2: For codelist columns, add codelist entries
                    if ({{ column.is_codelist|tojson }} && conceptGuid) {
                        // Update codelist data from final edit fields
                        const finalCodeInputs = document.querySelectorAll('.final-code-edit');
                        const finalLabelInputs = document.querySelectorAll('.final-label-edit');
                        
                        const finalCodes = {};
                        const finalLabels = {};
                        
                        // Collect final codes
                        finalCodeInputs.forEach(input => {
                            const value = input.getAttribute('data-value');
                            finalCodes[value] = input.value;
                            if (!finalLabels[value]) {
                                finalLabels[value] = {
                                    de: '', fr: '', it: '', en: ''
                                };
                            }
                        });
                        
                        // Collect final labels
                        finalLabelInputs.forEach(input => {
                            const value = input.getAttribute('data-value');
                            const lang = input.getAttribute('data-lang');
                            if (!finalLabels[value]) {
                                finalLabels[value] = {
                                    de: '', fr: '', it: '', en: ''
                                };
                            }
                            finalLabels[value][lang] = input.value;
                        });
                        
                        // Prepare codelist entries
                        const entries = [];
                        const column = {{ column|tojson }};
                        
                        if (column.unique_values && column.unique_values.length > 0) {
                            column.unique_values.forEach((value) => {
                                // Get final code
                                let code = value;
                                if (finalCodes[value]) {
                                    code = finalCodes[value];
                                }
                                
                                // Get final labels
                                let labels = null;
                                if (finalLabels[value]) {
                                    labels = finalLabels[value];
                                }
                                
                                // Create entry with multilingual labels
                                if (labels) {
                                    const entry = {
                                        code: code,
                                        name: labels,
                                        annotations: []
                                    };
                                    entries.push(entry);
                                } else {
                                    // Fallback to monolingual
                                    const entry = {
                                        code: code,
                                        name: String(value),
                                        annotations: []
                                    };
                                    entries.push(entry);
                                }
                            });
                            
                            // Create payload and submit codelist entries
                            const payload = { data: entries };
                            
                            showStatus('info', `Adding ${entries.length} codelist entries to concept...`);
                            
                            const codelistResponse = await fetch(`/api/add-codelist-entries/${conceptGuid}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify(payload)
                            });
                            
                            const codelistResult = await codelistResponse.json();
                            
                            if (!codelistResponse.ok || !codelistResult.success) {
                                throw new Error(codelistResult.message || 'Failed to add codelist entries');
                            }
                            
                            // Codelist entries added successfully
                            const codelistUrl = `https://input.i14y.admin.ch/catalog/concepts/${conceptGuid}`;
                            showStatus('success', `Successfully published concept with ${entries.length} codelist entries!`, codelistUrl);
                        }
                    }
                    
                    button.textContent = 'Published to I14Y';
                    
                } catch (error) {
                    console.error('Publish error:', error);
                    showStatus('error', `Error: ${error.message}`);
                    
                    // Re-enable button for retry
                    button.disabled = false;
                    button.textContent = 'Publish to I14Y';
                }
            });
            
            // Helper function to show status messages
            function showStatus(type, message, linkUrl = null) {
                const statusEl = document.getElementById('status-message');
                const statusArea = document.getElementById('status-area');
                
                // Remove old classes and add new one based on type
                statusArea.className = `status-area ${type}`;
                
                if (linkUrl) {
                    // Add a link to the message if URL is provided
                    statusEl.innerHTML = `${message} <a href="${linkUrl}" target="_blank" class="i14y-link">View on I14Y</a>`;
                } else {
                    statusEl.textContent = message;
                }
                
                statusArea.style.display = 'block';
            }
            
            // Pre-fill description field with default description on page load
            async function prefillDescription() {
                try {
                    const response = await fetch(`/api/get-default-description/${index}`);
                    const data = await response.json();
                    
                    if (response.ok && data.description) {
                        document.getElementById('description').value = data.description;
                        // Update the keywords button state after prefilling
                        updateKeywordsButtonState();
                    }
                } catch (error) {
                    console.error('Error loading default description:', error);
                }
            }
            
            // Initialize page
            prefillDescription();
        });
    </script>
</body>
</html>
