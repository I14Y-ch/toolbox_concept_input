<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I14Y Concept Import</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
    <header>
        <div class="header-wrapper">
            <div class="layout-brand">
                <div class="logo">
                    <a href="https://i14y.admin.ch">
                        <img src="{{ url_for('static', filename='logo_i14y.png') }}" alt="Logo I14Y">
                    </a>
                </div>
                <h1 class="header-title">I14Y Concept Import</h1>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="page-header">
                <h1>Generate I14Y Concepts from Data</h1>
                <p class="page-lead">Extract concepts from your data tables and publish them directly to I14Y.</p>
            </div>

            <!-- Upload and Configure -->
            <div id="upload-section" class="card">
                <h2 class="card-title">Upload Data & Configure</h2>
                <p class="card-description">Upload your Excel or CSV file. The metadata will be derived automatically from the data. Don't provide datasets containing sensitive or personal information.</p>

                <form id="upload-form" method="post" enctype="multipart/form-data">
                    <!-- Drag and Drop Area -->
                    <div id="drop-zone" style="border: 3px dashed var(--primary-color); border-radius: 12px; padding: 3rem 2rem; text-align: center; background: #fff5f5; margin-bottom: 1.5rem; transition: all 0.3s ease; cursor: pointer;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìÅ</div>
                        <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--primary-color); margin-bottom: 0.5rem;">Drop your file here</h3>
                        <p style="color: var(--secondary-text); margin-bottom: 1rem;">or</p>
                        <button type="button" id="select-file-btn" class="btn btn-primary" style="font-size: 1rem; padding: 0.75rem 2rem;">
                            <i class="fas fa-cloud-upload-alt" style="margin-right: 0.5rem;"></i>Select File
                        </button>
                        <input type="file" id="file" name="file" class="form-control" accept=".xlsx,.xls,.csv" required style="display: none;">
                        <p style="color: var(--secondary-text); font-size: 0.875rem; margin-top: 1rem;">Supported formats: Excel (.xlsx, .xls) or CSV</p>
                    </div>

                    <div class="form-group">
                        <label for="theme">Theme</label>
                        <select id="theme" name="theme" class="form-control" required>
                            <option value="">Select a theme...</option>
                            {% for code, name in themes.items() %}
                            <option value="{{ code }}">{{ code }} - {{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; font-size: 1rem; padding: 0.875rem 1.5rem; font-weight: 600;">
                        <i class="fas fa-play-circle" style="margin-right: 0.5rem;"></i>Analyze File
                    </button>
                </form>
            </div>

            <!-- Error container -->
            <div id="error-container"></div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-links">
                <h3>Links</h3>
                <ul>
                    <li><a href="https://www.bfs.admin.ch/bfs/de/home/bfs/bundesamt-statistik/rechtliche-hinweise.html" target="_blank">Rechtliche Hinweise</a></li>
                    <li><a href="https://github.com/i14y-ch" target="_blank">Github</a></li>
                    <li><a href="https://www.linkedin.com/showcase/i14y/about/" target="_blank">LinkedIn</a></li>
                    <li><a href="https://apiconsole.i14y.admin.ch/" target="_blank">API</a></li>
                </ul>
            </div>
            <div class="footer-info">
                <p>¬© 2025 Bundesamt f√ºr Statistik</p>
            </div>
        </div>
    </footer>


    <script>
        // Drag and drop functionality
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file');
        
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Highlight drop zone when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = '#4caf50';
                dropZone.style.backgroundColor = '#f0fdf4';
                dropZone.style.transform = 'scale(1.02)';
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = 'var(--primary-color)';
                dropZone.style.backgroundColor = '#fff5f5';
                dropZone.style.transform = 'scale(1)';
            }, false);
        });
        
        // Handle dropped files
        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            
            // Show selected file name
            if (files.length > 0) {
                const fileName = files[0].name;
                const fileNameDisplay = document.querySelector('[data-file-name]');
                if (!fileNameDisplay) {
                    const display = document.createElement('p');
                    display.setAttribute('data-file-name', '');
                    display.style.color = '#4caf50';
                    display.style.fontWeight = '600';
                    display.style.marginTop = '1rem';
                    display.textContent = '‚úì File selected: ' + fileName;
                    dropZone.appendChild(display);
                } else {
                    fileNameDisplay.textContent = '‚úì File selected: ' + fileName;
                }
            }
        }, false);
        
        // Handle file selection via button
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                const fileNameDisplay = document.querySelector('[data-file-name]');
                if (!fileNameDisplay) {
                    const display = document.createElement('p');
                    display.setAttribute('data-file-name', '');
                    display.style.color = '#4caf50';
                    display.style.fontWeight = '600';
                    display.style.marginTop = '1rem';
                    display.textContent = '‚úì File selected: ' + fileName;
                    dropZone.appendChild(display);
                } else {
                    fileNameDisplay.textContent = '‚úì File selected: ' + fileName;
                }
            }
        });
        
        // Trigger file input when "Select File" button is clicked
        document.getElementById('select-file-btn').addEventListener('click', (e) => {
            e.preventDefault();
            fileInput.click();
        });
        
        // Form submission
        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const errorContainer = document.getElementById('error-container');
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    
                    if (data.success && data.redirect_url) {
                        window.location.href = data.redirect_url;
                        return;
                    }
                    
                    if (data.error) {
                        errorContainer.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
                        return;
                    }
                } else {
                    errorContainer.innerHTML = '<div class="alert alert-error">Server error occurred. Please check the file format and try again.</div>';
                }
            } catch (error) {
                errorContainer.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        });
    </script>
</body>
</html>
